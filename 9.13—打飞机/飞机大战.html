<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
		<title>飞机大战</title>
		<link rel="stylesheet" type="text/css" href="css/打飞机.css" />
		<style type="text/css">
			.loading {
				position: absolute;
				background-image: url(img/background.png);
			}
			
			.loading img {
				position: absolute;
				top: 50%;
				left: 50%;
				margin-left: -15px;
				margin-top: -15px;
			}
			
			canvas {
				position: absolute;
				display: none;
			}
			
			.score {
				position: absolute;
				top: 20px;
				left: 20px;
				font-size: 2em;
				/*display: none;*/
			}
		</style>
	</head>

	<body>
		<div class="loading">
			<img src="img/loading.gif" alt="" />
		</div>
		<canvas id="" width="" height=""></canvas>
		<div class="score">得分：0</div>
	</body>
	<script type="text/javascript">
		loadDiv = document.querySelector(".loading");
		var loadImg = document.querySelector("img");
		var scoreDiv = document.querySelector(".score")
		var canvas = document.querySelector("canvas");
		var ctx = canvas.getContext("2d");

		//判断设备是否是pc
		function isPc() {
			var de = new Array('iPhone', 'Android', 'iPod', 'windows', 'Phone', 'SymbianOS');
			var info = navigator.userAgent;
			for(var i = 0; i < de.length; i++) {
				if(info.indexOf(de[i]) > -1) {
					return false;
				}
			}
			return true;
		}

		//更改canvas的大小
		if(isPc()) {
			loadDiv.style.width = "320px";
			loadDiv.style.height = '568px';
			canvas.width = 320;
			canvas.height = 568;
		} else {
			loadDiv.style.width = window.innerWidth + 'px';
			loadDiv.style.height = window.innerHeight + 'px';
			canvas.width = window.innerWidth;
			canvas.height = window.innerHeight;
		}
		var cw = canvas.width;
		var ch = canvas.height;
		//	总得分
		var scoreAll = 0;
		//	打印，验证是否正确
		console.log(canvas.width);
		console.log(canvas.height);

		//	我方飞机、英雄
		var hero = {
			x: cw / 2 - 33,
			y: ch - 82,
			w: 66,
			h: 82,
			isBol: false,
			picX: 0, //当飞机被撞时，更换图片所用的参数
			draw: function() {
				if(this.isBol && this.picX != 4) {
					this.picX++;
				}
				ctx.drawImage(heroImg, this.w * this.picX, 0, this.w, this.h, this.x, this.y, this.w, this.h)
			}
		}

		//敌机
		var enemyArr = []; // 这个用来存储敌机小对象
		var enemyNum = 200; //这个是随机数的取值范围，用来想支出项敌机的概率
		function Enemy(x, y, w, h, img, speed, hp, picMax, score) {
			this.x = x;
			this.y = y;
			this.w = w;
			this.h = h;
			this.img = img;
			this.speed = speed;
			this.hp = hp;
			this.picX = 0;
			this.picMax = picMax;
			this.clear = false;
			this.score = score;
		}
		Enemy.prototype.move = function() {
				this.y += this.speed;
				if(this.hp <= 0) {
					this.picX++;
					if(this.picX >= this.picMax) {
						this.clear = true;
						scoreAll += this.score;
						scoreDiv.innerHTML = "得分：" + scoreAll;
						return;
					}
				}
				ctx.drawImage(this.img, this.picX * this.w, 0, this.w, this.h, this.x, this.y, this.w, this.h)
			}
			//	子弹

		var bullArr = [];
		var bullNum = 7; //用来控制子弹的时间间隔
		var bn = 0; // 同上 配合使用；
		var bullType = 1; // 1就是排子弹 2就是二排子弹
		function Bullert(x, y, w, h, img, hurt /*伤害*/ ) {
			this.x = x;
			this.y = y;
			this.w = w;
			this.h = h;
			this.img = img;
			this.hurt = hurt;
			this.speed = 9;
		}
		Bullert.prototype.move = function() {
				this.y -= this.speed;
				ctx.drawImage(this.img, this.x, this.y, this.w, this.h);
			}
			//预加载图片
		var bgImg = null; //背景
		var bombImg = null; //炸弹
		var bull1 = null; //子弹1
		var bull2 = null; //子弹2
		var enemy1 = null; //敌机1
		var enemy2 = null; //敌机2
		var enemy3 = null; //敌机3
		var heroImg = null; //我方飞机
		var prop = null; //降落伞奖励
		var timer = null; //用来计时
		var loadNum = 0; //用来记录加载好的图片的数量
		var loadArr = [];

		var pic_load = ["img/background.png", "img/bomb.png",
			"img/bullet1.png", "img/bullet2.png", "img/enemy1.png",
			"img/enemy2.png", "img/enemy3.png", "img/herofly.png",
			"img/prop.png"
		]
		for(var i = 0; i < pic_load.length; i++) {
			var img = new Image();
			img.src = pic_load[i];
			loadArr.push(img);
			img.onload = function() {
				loadNum++;
				if(loadNum === pic_load.length) {
					loadDiv.style.display = "none";
					canvas.style.display = "block";
					//	背景滚动  飞机 敌机 子弹
					pair(); //	配对图片

					//封装了一个函数，用来背景滚动  飞机 敌机 子弹
					var timer = setInterval(animate, 30);
				}
			}
		}

		//	图片配对
		function pair() {
			bgImg = loadArr[0]; //背景
			bombImg = loadArr[1]; //炸弹
			bull1 = loadArr[2]; //子弹1
			bull2 = loadArr[3]; //子弹2
			enemy1 = loadArr[4]; //敌机1
			enemy2 = loadArr[5]; //敌机2
			enemy3 = loadArr[6]; //敌机3
			heroImg = loadArr[7]; //我方飞机
			prop = loadArr[8]; //降落伞奖励
		}

		function animate() {
			//	清空画布
			ctx.clearRect(0, 0, cw, ch);
			//	背景滚动
			bgScroll()
				//	绘制飞机滚动
			heroMove();
			//	绘制敌机滚动
			drawEnemy();
			//	绘制子弹
			drawBullert();
		}

		//	背景滚动参数
		var bgy = 0;

		function bgScroll() {
			bgy += 5;
			if(bgy > ch) {
				bgy = 0;
			}
			ctx.drawImage(bgImg, 0, bgy, cw, ch);
			ctx.drawImage(bgImg, 0, -ch + bgy, cw, ch);
		}
		//	键盘操作的控制左右的参数

		var hl = false;
		var ht = false;
		var hr = false;
		var hb = false;
		// 用来对hero的参数进行变化的
		function heroMove() {
			if(hl) {
				hero.x -= 9;
				hero.x = (hero.x < 0) ? 0 : hero.x;
			} else if(ht) {
				hero.y -= 9;
				hero.y = (hero.y < 0) ? 0 : hero.y;
			} else if(hr) {
				hero.x += 9;
				hero.x = (hero.x > cw - hero.w) ? cw - hero.w : hero.x;
			} else if(hb) {
				hero.y += 9;
				hero.y = (hero.y > ch - hero.h) ? ch - hero.h : hero.y;
			}
			hero.draw();
		}
		// 随机获取位置
		function fnRand(min, max) {
			return Math.ceil(Math.random() * (max - min) + min);
		}

		//创建敌机 
		function createEnemy() {
			var num = fnRand(0, 200);
			var x = 0;
			var y = 0;
			var w = 0;
			var h = 0;
			var img = null;
			var speed = 0;
			var hp = 0;
			var picMax = 0;
			if(num <= 10) {
				if(num == 9) {
					//创建大型敌机
					x = fnRand(0, cw - 110);
					y = -164;
					w = 110;
					h = 164;
					img = enemy2;
					hp = 600;
					speed = fnRand(3, 5);
					picMax = 9;
					score = 600;
				} else if(num > 8) {
					//创建中型敌机
					x = fnRand(0, cw - 46);
					y = -64;
					w = 46;
					h = 64;
					img = enemy3;
					hp = 300;
					speed = fnRand(3, 7);
					picMax = 5;
					score = 200;
				} else {
					//创建小型敌机
					x = fnRand(0, cw - 38);
					y = -34;
					w = 38;
					h = 34;
					img = enemy1;
					hp = 100;
					speed = fnRand(3, 10);
					picMax = 4;
					score = 100;
				}
				enemy = new Enemy(x, y, w, h, img, speed, hp, picMax, score);
				enemyArr.push(enemy);
			}
		}
		//	绘制敌机
		function drawEnemy() {
			createEnemy();
			//	用来存储飞出屏幕的enemy
			for(var i = 0; i < enemyArr.length; i++) {
				enemyArr[i].move();

				if(enemyArr[i].y >= ch || enemyArr[i].clear) {
					//	敌机超出屏幕
					enemyArr.splice(i, 1);
					i--;
					continue;
				}
				//	检测是否碰撞到hero
				if(isCrash(hero, enemyArr[i])) {
					hero.isBol = true;
				}
			}
		}
		//	创建子弹
		function createBullert() {
			bn++;
			if(bn > 140) {
				bn = 1;
			}
			if(bn % bullNum == 0) {
				var x = 0;
				var y = 0;
				var w = 0;
				var h = 0;
				var bullert = null;
				if(bullType == 1) {
					// 1 排子弹 的 横坐标 、 纵坐标 、 自身的宽度、高度 、伤害力
					x = hero.x + hero.w / 2 - 3;
					y = hero.y - 14;
					w = 6;
					h = 14;
					img = bull1;
					hurt = 100;
				} else {
					// 2 排子弹 的 横坐标 、 纵坐标 、 自身的宽度、高度 、伤害力
					x = hero.x + hero.w / 2 - 24;
					y = hero.y + 14;
					w = 48;
					h = 14;
					img = bull2;
					hurt = 200;
				}
				bullert = new Bullert(x, y, w, h, img, hurt);
				bullArr.push(bullert);
			}
		}
		// 绘制子弹
		function drawBullert() {
			createBullert();
			for(var i = 0; i < bullArr.length; i++) {
				bullArr[i].move();
				if(bullArr[i].y < -14) {
					bullArr.splice(i, 1);
					i--;
					continue;
				}
				// 循环敌机
				for(var j = 0; j < enemyArr.length; j++) {
					if(isCrash(bullArr[i], enemyArr[j]) && enemyArr[j].hp > 0 && !hero.isBol) {
						// 碰到了  敌机减血
						enemyArr[j].hp -= bullArr[i].hurt;

						// 碰到了 子弹消失
						bullArr.splice(i, 1);
						i--;
						//	结束内部循环
						break;
					}
				}
				for(var k = 0; k < enemyArr.length; k++) {

				}
			}
		}

		//检测碰撞  		.x  这种形式是多态
		function isCrash(first, second) {
			var l1 = first.x;
			var t1 = first.y;
			var r1 = first.w + first.x;
			var b1 = first.h + first.y;

			var l2 = second.x;
			var t2 = second.y;
			var r2 = second.w + second.x;
			var b2 = second.h + second.y;
			if(l2 > r1 || r2 < l1 || t2 > b1 || b2 < t1) {
				return false;
			}
			return true;
		}
		//	键盘操作事件
		document.addEventListener("keydown", function(event) {
			var e = event || window.event;
			switch(e.keyCode) {
				case 37:
					hl = true;
					ht = false;
					hr = false;
					hb = false;
					break;
				case 38:
					hl = false;
					ht = true;
					hr = false;
					hb = false;
					break;
				case 39:
					hl = false;
					ht = false;
					hr = true;
					hb = false;
					break;
				case 40:
					hl = false;
					ht = false;
					hr = false;
					hb = true;
					break;
				default:
					break;
			}
		}, false);
		document.addEventListener("keyup", function(event) {
			var e = event || window.event;
			switch(e.keyCode) {
				case 37:
					hl = false;
					ht = false;
					hr = false;
					hb = false;
					break;
				case 38:
					hl = false;
					ht = false;
					hr = false;
					hb = false;
					break;
				case 39:
					hl = false;
					ht = false;
					hr = false;
					hb = false;
					break;
				case 40:
					hl = false;
					ht = false;
					hr = false;
					hb = false;
					break;
				default:
					break;
			}
		}, false);

		//触屏事件
		var isTouch = false;
		canvas.addEventListener("touchstart", touchStart, false);
		canvas.addEventListener("touchend", function() {
			isTouch = false;
		}, false);
		canvas.addEventListener("touchmove", function(event2) {
			if(isTouch) {
				var e2 = event2 || window.event;
				var x2 = e2.touches[0].clientX - canvas.offsetLeft;
				var y2 = e2.touches[0].clientY - canvas.offsetTop;
				hero.x = x2 - hero.w / 2;
				hero.y = y2 - hero.h / 2;
			}
		}, false);

		function touchStart(event) {
			var e = event || window.event;
			var x = e.touches[0].clientX - canvas.offsetLeft;
			var y = e.touches[0].clientY - canvas.offsetTop;
			//判断是否点中飞机
			if(x > hero.x && x < hero.x + hero.w && y > hero.y && y < hero.y + hero.h) {
				isTouch = true;
			}
		}
	</script>

</html>